<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sseju.java.workorder.mapper.WorkOrderMapper">

	<!-- 작업 지시 등록 -->
	<insert id="insertWorkOrder" parameterType="woVO">
		<selectKey keyProperty="preNo" resultType="String" order="BEFORE">
			SELECT 'PRE_' || TO_CHAR(SYSDATE,'YYYYMMDD')||'-'||LPAD(NVL(MAX(SUBSTR(pre_no, -3)),0)+1,3,0) 
			FROM	produce
		</selectKey>
		INSERT INTO produce( pre_no
						    ,pre_date
						    ,pre_manager
						    ,ins_qty
						    ,pre_qty
						    ,prt_code
						    ,oder_no
						    ,pre_prg)
				   VALUES( #{preNo}
						   ,#{preDate}
						   ,#{preManager}
						   ,#{insQty}
						   ,0 <!-- 생산 지시 등록 시 기본값 0이 들어가게 -->
						   ,#{prtCode}
						   ,#{oderNo}
						   ,#{prePrg})
	</insert>
	<!-- 작업 지시 전체 조회 -->
	<select id="getWorkOrderList" resultType="woVO">
		SELECT pe.pre_no, ods.d_day,(SELECT pt.prt_name
		                             FROM product pt JOIN produce pe
		                             ON pt.prt_code = pe.prt_code) AS prt_name,
		        pe.pre_qty, pe.ins_qty, pe.pre_prg
		FROM produce pe JOIN orders ods
		ON ods.order_no = pe.order_no
		WHERE ods.order_no = pe.order_no
	</select>
	
	<!-- 단건조회 -->
	<select id="getSearchWorkOrder" parameterType="woVO" resultType="woVO">
		SELECT pre_no,
			   pre_date,
			   pre_manager,
			   ins_qty,
			   pre_qty,
			   prt_code,
			   oder_no,
			   pre_prg
		FROM produce
		<where>
			preNo = ${preNO}
		</where>
	</select>

	<!-- 수정 -->
	<update id="updateWorkOrder" parameterType="woVO">
		UPDATE produce
		<set>
			pre_manager = #{preManager},
			ins_qty = #{insQty},
			pre_qty = #{preQty},
			pre_prg = #{prePrg}
		</set>
		WHERE pre_no = #{preNo}
	</update>
	
	<!-- 삭제 -->
	<delete id="deleteWorkOrder" parameterType="Integer">
		DELETE FROM produce
		WHERE pre_no = #{preNo}
	</delete>
	
	<!-- 작업 지시 번호 조회 -->
	<select id="getWoNo" resultType="woVO">
		SELECT 'PRE_' || TO_CHAR(SYSDATE,'YYYYMMDD')||'-'||LPAD(NVL(MAX(SUBSTR(pre_no, -3)),0)+1,3,0) AS preNo
		FROM produce
		WHERE pre_no = #{preNO}
	</select>
</mapper>
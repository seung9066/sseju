<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sseju.java.workorder.mapper.WorkOrderMapper">

	<!-- 주문 번호, 주문한 상품명, 주문수량, 주문일자 불러오기 -->
	<select id="getOrderList" resultType="woVO">
	SELECT ods.order_no, 
		(SELECT pt.prt_code
	     FROM product pt JOIN order_inf odi
	     ON pt.prt_code = odi.prt_code
	     JOIN orders ods
	     ON odi.order_no = ods.order_no) AS prt_code,
		(SELECT pt.prt_name
		 FROM product pt JOIN order_inf odi
		 ON pt.prt_code = odi.prt_code
		 JOIN orders ods
		 ON odi.order_no = ods.order_no) AS prt_name,	                        
	        odi.order_qty, ods.order_date
	FROM orders ods JOIN order_inf odi
	ON ods.order_no = odi.order_no
	</select>

	<!-- 작업 지시 등록 -->
	<insert id="insertWorkOrder" parameterType="woVO">
		<selectKey keyProperty="preNo" resultType="String" order="BEFORE">
			SELECT 'PRE'||TO_CHAR(SYSDATE,'YYYYMMDD')||LPAD(NVL(MAX(SUBSTR(pre_no, -3)),0)+1,3,0) 
			FROM	produce
		</selectKey>
		<!-- (SELECT ods.d_day
						      FROM orders ods JOIN produce pe
						      ON ods.order_no = pe.order_no) AS -->
		<!-- INSERT ALL
		INTO orders(d_day) VALUES(#{dDay}) -->
		INSERT INTO produce( pre_no
						    ,pre_date
						    ,pre_manager
						    ,ins_qty
						    ,pre_qty
						    ,prt_code
						    ,order_no)
				   VALUES(  #{preNo}
						   ,#{preDate}
						   ,#{empId}
						   ,#{insQty}
						   ,0 <!-- 생산 지시 등록 시 기본값 0이 들어가게 -->
						   ,#{prtCode}
						   ,#{orderNo}
						   )
	</insert>
	
	<!-- 작업 지시 전체 조회 -->
	<select id="getWorkOrderList" resultType="woVO">
				SELECT ods.order_no, pe.pre_no, pe.pre_date,(SELECT pt.prt_name
		                             FROM product pt JOIN produce pe
		                             ON pt.prt_code = pe.prt_code
                                     JOIN orders ods
                                     on pe.order_no = ods.order_no
                                     GROUP BY pt.prt_name) AS prt_name,
		        pe.pre_qty, pe.ins_qty, pe.pre_prg
		FROM produce pe JOIN orders ods
		ON ods.order_no = pe.order_no
	</select>
	
	<!-- 단건조회 -->
	<select id="getSearchWorkOrder" parameterType="woVO" resultType="woVO">
	SELECT ods.order_no,
	       pe.pre_no,
	       pe.pre_date,
	       pe.pre_manager,
	       pe.ins_qty,
	       pe.pre_qty,
	       pe.prt_code,
	       pe.pre_prg
	FROM produce pe JOIN orders ods
	ON pe.order_no = ods.order_no
	<where>
	ods.order_no = #{orderNo}
	</where> 
	</select>
	
	<!-- 상품 코드, 이름 가져오기, 
	workorder.html에서 select박스에 제품 종류 띄워주기 위해서 -->
	<select id="getPrtList" resultType="woVO">
		SELECT *
		FROM product
	</select>
	
	<!-- 직원 아이디, 이름 가져오기 -->
	<select id="getManagerList" resultType="woVO">
		SELECT *
		FROM employee
	</select>

	<!-- 수정 -->
	<update id="updateWorkOrder" parameterType="woVO">
		UPDATE produce
		<set>
			pre_manager = #{preManager},
			ins_qty = #{insQty},
			pre_qty = #{preQty},
			pre_prg = #{prePrg}
		</set>
		WHERE pre_no = #{preNo}
	</update>
	
	<!-- 삭제 -->
	<delete id="deleteWorkOrder" parameterType="woVO">
		DELETE FROM produce
		WHERE pre_no = #{preNo}
	</delete>
	
	<!-- 작업 지시 번호 조회 -->
	<select id="getWoNo" resultType="woVO">
		SELECT 'PRE' || TO_CHAR(SYSDATE,'YYYYMMDD')||'-'||LPAD(NVL(MAX(SUBSTR(pre_no, -3)),0)+1,3,0) AS preNo
		FROM produce
		WHERE pre_no = #{preNO}
	</select>
</mapper>
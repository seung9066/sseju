<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{/layout/layout}">

<head>
<meta charset="UTF-8">
<title>eqmList</title>

<!--jquery  -->
<script src="https://code.jquery.com/jquery-latest.min.js"></script>
<!--toast grid  -->
<link rel="stylesheet"
	href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
<script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>
<!--부트스트랩 아이콘  -->
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.1/font/bootstrap-icons.css">


<style type="text/css">

/* ul 스타일 */
.ul-style {
	list-style: none;
	padding: 0px;
}

.ul-style li>label {
	width: 100px;
	text-align: center;
}

.ul-style li {
	padding: 5px;
}

.row {
	margin: 15px;
}


.col1 {
	background-color: #e8e8e8;
	padding: 10px;
	text-align: center;
	font-weight: bold;
	font-size: 0.9em;
}

#dis td {
	padding-left: 10px;
}
</style>


</head>

<body>
	<br>

	<article layout:fragment="content">
		<main id="main" class="main">
			<h4>
				<strong>설비점검관리</strong>
			</h4>

			<hr>
			<div id="input-group">
				<ul class="ul-style">
					<li><span>해당일자</span> &nbsp;&nbsp;&nbsp;<input type="date"><span>
							- </span><input type="date"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
					<span>설비구분</span>&nbsp;&nbsp;&nbsp; 
					<select>
							<option selected>전체</option>
							<option value="1">bottle</option>
							<option value="2">inject</option>
							<option value="3">package</option>
					</select></li>
				</ul>
			</div>
		
			
			<div style="float: right;">
				<button class="button" type="button">조회</button>
				<button class="button" id="show" onclick="dis()">등록</button>
				<button class="button">수정</button>
				<button class="button">삭제</button>
			</div>
			<br>
			<hr>

			<div id="chkGrid"></div>
			<br> <br>

			<!-- 등록 폼 : hidden/show  -->
			<form action="insertEqm" method="POST">
				<input type="hidden" th:name="${_csrf.parameterName}"
					th:value="${_csrf.token}" />
				<div id='dis' style="display: none;">
					<table>
						<tr>
							<th class="col1">정기점검이력번호</th>
							<td><input type="text" name="" readonly></td>
							<th class="col1">설비코드</th>
							<td><input type="text" name=""> <i
								class="bi bi-search" data-bs-toggle="modal"
								data-bs-target="#eqmModal"></i></td>
							<th class="col1">설비명</th>
							<td><input type="text" name=""></td>
							<th class="col1">공정명</th>
							<td><input type="text" name=""></td>
						</tr>
						<tr>
							<th class="col1">점검일</th>
							<td><input type="date" name=""></td>
							<th class="col1">차기점검일</th>
							<td><input type="date" name=""></td>
							<th class="col1">판정</th>
							<td><input type="radio" name="chk" value="nor">정상<input
								type="radio" name="chk" value="abnor">불량</td>
							<th class="col1">담당자</th>
							<td><input type="text" name=""><i
								class="bi bi-search" data-bs-toggle="modal"
								data-bs-target="#empModal"></i></td>
							<th class="col1">조치사항</th>
							<td><textarea placeholder="입력하시오."></textarea></td>
						</tr>

					</table>
				</div>
			</form>

			

			<!-- 설비 모달  -->
			<div class="modal" tabindex="-1" role="dialog" id="eqmModal">
				<div class="modal-dialog" role="document">
					<div class="modal-content">
						<div class="modal-header">
							<h5 class="modal-title">
								<b>설비코드</b>
							</h5>
							<button type="button" class="close" data-bs-dismiss="modal"
								aria-label="Close">
								<span aria-hidden="true">&times;</span>
							</button>
						</div>
						<div class="modal-body">
							<div id="eqmGrid"></div>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-primary">선택</button>
							<button type="button" class="btn btn-secondary"
								data-bs-dismiss="modal">취소</button>
						</div>
					</div>
				</div>
			</div>

			<!-- 사원 모달  -->
			<div class="modal" tabindex="-1" role="dialog" id="empModal">
				<div class="modal-dialog" role="document">
					<div class="modal-content">
						<div class="modal-header">
							<h5 class="modal-title">
								<b>사원코드</b>
							</h5>
							<button type="button" class="close" data-bs-dismiss="modal"
								aria-label="Close">
								<span aria-hidden="true">&times;</span>
							</button>
						</div>
						<div class="modal-body">
							<div id="empGrid"></div>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-primary">선택</button>
							<button type="button" class="btn btn-secondary"
								data-bs-dismiss="modal">취소</button>
						</div>
					</div>
				</div>
			</div>


		
         
		<script type="text/javascript">
         function dis(){
            if($('#dis').css('display') == 'none'){
               $('#dis').show();
               }else{
                  $('#dis').hide();
               }
            };
            
         document.addEventListener('shown.bs.modal', function (){
                eqmGrid.refreshLayout();
                }, '.modal');
            
         
            
         </script>

		<script>
		showAll();
		
            var chkGrid = new tui.Grid({
               el : document.getElementById('chkGrid'),
               scrollX : false,
               scrollY : false,
               rowHeaders : [ 'checkbox' ],
               columns : [ {
                  header : '정기점검이력번호',
                  name : 'checkNo',
                  align : 'center',
                  filter: 'select'
               }, {
                  header : '설비코드',
                  name : 'eqmCode',
                  align : 'center',
                  filter: 'select'
               }, {
                  header : '설비명',
                  name : 'eqmName',
                  align : 'center',
                  filter: 'select'
               }, {
                  header : '공정코드',
                  name : 'prsCode',
                  align : 'center',
                  filter: 'select'
               }, {
                  header : '점검일',
                  name : 'chkDate',
                  align : 'center',
                  filter: 'select'
               }, {
                  header : '차기점검일',
                  name : 'chkNdate',
                  align : 'center',
                  filter: 'select'
               }, {
                  header : '판정',
                  name : 'chkState',
                  align : 'center',
                  filter: 'select'
               }, {
                  header : '조치사항',
                  name : 'chkSol',
                  align : 'center',
                  filter: 'select'
               }, {
                  header : '점검 담당자',
                  name : 'chkEmpNo',
                  align : 'center',
                  filter: 'select'
               } ]
            });
            
            var token = $("meta[name='_csrf']").attr("content");
            var header = $("meta[name='_csrf_header']").attr("content");
            
            var checked = [];
            
            chkGrid.on('click', ev => {
            	checked.push((chkGrid.getValue(ev.rowKey,'chkNo')));
            	
            	$('#checkNo').val(chkGrid.getValue(ev.rowKey,'checkNo'));
            	$('#checkNo').attr('readonly',true);
            	$('#eqmCode').val(chkGrid.getValue(ev.rowKey,'eqmCode'));
            	$('#eqmName').val(chkGrid.getValue(ev.rowKey,'eqmName'));
            	$('#prsCode').val(chkGrid.getValue(ev.rowKey,'prsCode'));
            	$('#chkDate').val(chkGrid.getValue(ev.rowKey,'chkDate'));
            	$('#chkNdate').val(chkGrid.getValue(ev.rowKey,'chkNdate'));
            	$('#chkState').val(chkGrid.getValue(ev.rowKey,'chkState'));
            	$('#chkSol').val(chkGrid.getValue(ev.rowKey,'chkSol'));
            	$('#chkEmpNo').val(chkGrid.getValue(ev.rowKey,'chkEmpNo'));
            });
            
            chkGrid.on('uncheck', ev => {
                for(let i=0; i<checked.length; i++){
                   if(checked[i] == chkGrid.getValue(ev.rowKey,'chkNo')){
                	   checked.splice(i,1);
                   }
                }
                $('#checkNo').val('');
                $('#checkNo').attr('readonly',false);
            	$('#eqmCode').val('');
            	$('#eqmName').val('');
            	$('#prsCode').val('');
            	$('#chkDate').val('');
            	$('#chkNdate').val('');
            	$('#chkState').val('');
            	$('#chkSol').val('');
            	$('#chkEmpNo').val('');
            });
            
            function deleteChk(){
                let chk = [];
                for(c of chkGrid.getCheckedRows()){
                	chk.push(c.chkNo);
                }
             
                $.ajax({
                   url : 'deleteChk',
                   type : 'POST',
                   data : {chk:chk},
                   dataType:"json",
                   async:false,
                   beforeSend : function(xhr){
                      xhr.setRequestHeader(header, token);
                   },
                   success:function(data){
                      if(data > 0) {
                         alert("삭제완료");
                         showAll();               
                      } else {
                         alert("삭제실패");
                      }
                   },
                   error : function(reject){
                      console.log(reject);
                   }
                })
             }
            
            function updateLine(){
                let checkNo = $('#checkNo').val();
                let eqmCode = $('#eqmCode').val();
                let eqmName = $('#eqmName').val();
                let prsCode = $('#prsCode').val();
                let chkDate = $('#chkDate').val();
                let chkNdate = $('#chkNdate').val();
                let chkState = $('#chkState').val();
                let chkSol = $('#chkSol').val();
                let chkEmpNo = $('#chkEmpNo').val();
               
                
                let updChk={'lineNo':lineNo, 'eqmCode':eqmCode, 'eqmName':eqmName, 'prsCode':prsCode, 'chkDate':chkDate, 'chkNdate':chkNdate, 'chkState':chkState, 'chkSol':chkSol, 'chkEmpNo':chkEmpNo};
                
                $.ajax({
                   url : 'updateChk',
                   type : 'POST',
                   data : JSON.stringify(updChk),
                   dataType : "json",
                   contentType: 'application/json',
                   async : false,
                   beforeSend : function(xhr){
                      xhr.setRequestHeader(header, token);
                   },
                   success:function(data){
                      if(data > 0) {
                         alert("수정완료");
                         showAll();               
                      } else {
                         alert("수정실패");
                      }
                   },
                   error:function(reject){
                      console.log(reject);
                   }
                })
             }
            
            function showAll() {
                
                fetch("eqmChkList") 
                .then(res=>res.json())
                .then(obj=>{
                    chkGrid.resetData(obj);
                })
         }
            
            var myModal = document.getElementById('myModal')
            var myInput = document.getElementById('myInput')

            myModal.addEventListener('shown.bs.modal', function () {
              myInput.focus()
            })
         </script>
		


			<!-- 본문 끝 -->

		</main>

	</article>

</body>

</html>
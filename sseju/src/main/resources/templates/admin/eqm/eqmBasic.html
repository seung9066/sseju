<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
   xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5"
   xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
   layout:decorate="~{/layout/layout}">
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<!-- 제이쿼리 -->
<script   src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
<!-- 토스트UI -->
<link rel="stylesheet" href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
<script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>
<style>
.showModal {
	/* 커서 손모양 */
	cursor: pointer;
}


</style>
</head>
<body>
   <article layout:fragment="content">
      <main id="main" class="main">
         <h4>
            <strong>설비정보 관리</strong>
         </h4>

         <br>
         <hr>

         <div class="row">
               <div class="col-6">	
                  <h5 style="width: 200px">
                     <b>라인정보 관리</b>
                  </h5>
                  <div style="float:right;">
                  
                     
                     
                  </div>
                  
                  <div id="lineGrid"></div>
               </div>
               <!-- 라인 등록 폼 : show/hidden  -->
               <div  class="col-6">
                  <br>
                 
                     <input type="hidden" th:name="${_csrf.parameterName}"
                        th:value="${_csrf.token}" />
                     <form id="lineForm">
                        <input type="hidden" name="auth" value="ROLE_ADMIN">
                        <div style="float:right;">
                        <button type="button" class="button" onclick="insertLine()" id="ins">등록</button>
                        <button type="button" class="button" onclick="updateLine()" id="upd">수정</button>
                        <button type="button" class="button" id="deleteBt"
                              onclick="deleteLine()">삭제</button>
                        <button type="reset" class="button" >초기화</button>   
                        </div>
                        
                     	<table class="table">
                        <tr>
                           <th>*라인명</th>
                           <td><input type="text" name="lineNo" id="lineNo"></td>
                           <th>*담당자</th>
                           <td><input type="text" name="empNo" id="empNo" data-bs-toggle="modal" data-bs-target="#empModal" class="showModal" readonly></td>
                        </tr>
                        <tr>
                           <th>*총생산량</th>
                           <td><input type="number" name="totPrc" id="totPrc" min="1"></td>
                           <th>*UPH</th>
                           <td><input type="number" name="uph" id="uph" min="1"> </td>
                           
                           
                        </tr>
                        <tr>
                           <th>*사용여부</th>
                           <td><input type="radio" name="lineYn" id="lineYn"
                              value="Y" style="vertical-align: 0px;">Y <input
                              type="radio"  name="lineYn" value="N" id="lineYn"
                              style="vertical-align: 1px;">N</td>
                        </tr>
                     </table>
                     </form>
                 
               </div>
             </div>
             
             <!--사원 모달 : 그리드  -->
			<div class="modal" tabindex="-1" role="dialog" id="empModal">
				<div class="modal-dialog" role="document">
					<div class="modal-content">
						<div class="modal-header">
							<h5 class="modal-title">
								<b>사원 리스트</b>
							</h5>
						</div>
						<div class="modal-body">
							<!-- 거래처 리스트  -->
							<div id="empGrid"></div>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-secondary"
								data-bs-dismiss="modal">취소</button>
						</div>
					</div>
				</div>
			</div>
               <!-- 등록 폼 end  -->
               <!-- 라인정보관리 등록 폼 : show/hide -->
         <script type="text/javascript">
         
         
         // toastr
         toastr.options = {
                "closeButton": false,
                "newestOnTop": true,
                "positionClass": "toast-top-center",
                "preventDuplicates": true,
                "extendedTimeOut" : 1500, 
                "timeOut" : 2500
         }
         
         
         
            function dis() {
               if ($('#dis').css('display') == 'none') {
                  $('#dis').show();
               } else {
                  $('#dis').hide();
               }
            };
            
            //모달클릭
            document.addEventListener('shown.bs.modal', function() {
                empGrid.refreshLayout();
               }, '.modal');
            
            // 유효성 체크(uph,totPrc에 숫자가 아닌 값이 들어가면 )
           
               
         </script>

         <script type="text/javascript">
         
        
            showAll();
            emp();
            

            var lineGrid = new tui.Grid({
               el : document.getElementById('lineGrid'),
               scrollX : false,
               scrollY : true,
               rowHeaders : [ 'checkbox' ],
               columns : [ {
                  header : '라인명',
                  name : 'lineNo',
                  align : 'center'
               },
               {
                  header : '총생산량',
                  name : 'totPrc',
                  align : 'right'
               },{
                  header : 'UPH',
                  name : 'uph',
                  align : 'right'
               }, {
                  header : '사용여부',
                  name : 'lineYn',
                  align : 'center'
               }, {
                  header : '담당자',
                  name : 'empNo',
                  align : 'center'
               } ]
            });
            
            var token = $("meta[name='_csrf']").attr("content");
            var header = $("meta[name='_csrf_header']").attr("content");
            
            var chkLine = [];
            
            lineGrid.on('check', ev => {
               chkLine.push((lineGrid.getValue(ev.rowKey,'lineNo')));
               
               $('#lineNo').val(lineGrid.getValue(ev.rowKey,'lineNo'));
               $('#lineNo').attr('readonly',true);
               $('#totPrc').val(lineGrid.getValue(ev.rowKey,'totPrc'));
               $('#uph').val(lineGrid.getValue(ev.rowKey,'uph'));
               $("input[name='lineYn']").val([lineGrid.getValue(ev.rowKey,'lineYn')]);  // select/option, radio, checkbox는 배열로 묶어준다.
               $('#empNo').val(lineGrid.getValue(ev.rowKey,'empNo'));
            });
            
            lineGrid.on('uncheck', ev => {
               for(let i=0; i<chkLine.length; i++){
                  if(chkLine[i] == lineGrid.getValue(ev.rowKey,'lineNo')){
                     chkLine.splice(i,1);
                  }
               }
               $('#lineNo').val('');
               $('#lineNo').attr('readonly',false);
               $('#totPrc').val('');
               $('#uph').val('');
               $("input[name='lineYn']").val([]);
               $('#empNo').val('');   
            });
            
            function insertLine(){
            	/*let lineNo = $('#lineNo').val();
            	let totPrc = $('#totPrc').val();
            	let uph = $('#uph').val();
            	let lineYn = $("input[name='lineYn']:checked").val();
            	let empNo = $('#empNo').val();*/
            	
            	let eqmLine = $('#lineForm').serialize();
            	$.ajax({
            		url:'insertLine',
            		type : 'POST',
            		data : eqmLine, //{'lineNo':lineNo, 'totPrc' : totPrc , 'uph':uph, 'lineYn':lineYn,'empNo':empNo},
            		dataType : "json",
                    async : false,
                    beforeSend : function(xhr){
                       xhr.setRequestHeader(header, token);
                    },
                    success:function(data){
                       if(data > 0) {
                    	  toastr.success("등록 성공하였습니다!")
                          showAll();
                         lineForm.reset();
                       } else {
                          toastr.error("등록 실패하였습니다.")
                          
                       }
                    },error : function(reject){
                    	console.log(reject);
                    }
            		
            		
            	});
            }
            
            function deleteLine(){
               let line = [];
               for(li of lineGrid.getCheckedRows()){
                  line.push(li.lineNo);
               }
            	console.log(line);
               $.ajax({
                  url : 'deleteLine',
                  type : 'POST',
                  data : {line:line},
                  dataType:"json",
                  async:false,
                  beforeSend : function(xhr){
                     xhr.setRequestHeader(header, token);
                  },
                  success:function(data){
                     if(data > 0) {
                    	toastr.success("삭제에 성공하였습니다!");
                        showAll();
                        lineForm.reset();
                        
                     } else {
                    	 toastr.success("삭제에 실패하였습니다!");
                         lineForm.reset();
                     }
                  },
                  error : function(reject){
                     console.log(reject);
                  }
               })
            }
            
            function updateLine(){
               let lineNo = $('#lineNo').val();
               let totPrc = $('#totPrc').val();
               let uph = $('#uph').val();
               let lineYn = $("input[name='lineYn']:checked").val();;
               let empNo = $('#empNo').val();
               let updLine={'lineNo':lineNo, 'totPrc':totPrc, 'uph':uph, 'lineYn':lineYn, 'empNo':empNo}
               
               $.ajax({
                  url : 'updateLine',
                  type : 'POST',
                  data : JSON.stringify(updLine),
                  dataType : "json",
                  contentType: 'application/json',
                  async : false,
                  beforeSend : function(xhr){
                     xhr.setRequestHeader(header, token);
                  },
                  success:function(data){
                     if(data > 0) {
                        toastr.success("수정에 성공하였습니다.")
                        showAll();   
                        lineForm.reset();
                        
                     } else {
                         toastr.error("수정에 실패하였습니다.");
                        
                     }
                  },
                  error:function(reject){
                     console.log(reject);
                  }
               })
            }
                  
               
            
            function showAll(){
               
               fetch("lineList")
               .then(res=>res.json())
               .then(obj=>{
                  lineGrid.resetData(obj);
               })
            }
            
            
            // 사원 모달-그리드
			   var empGrid = new tui.Grid({
	               el : document.getElementById('empGrid'),
	               scrollX : false,
	               scrollY : true,
	               pageOptions: {
	            	    useClient: true, // front에서만 페이징하는 속성(서버x)
	            	    perPage: 5
	            	  },
	               columns : [{
	                  header : '아이디',
	                  name : 'empId',
	                  align : 'center'
	                  
	               }, {
	                  header : '이름',
	                  name : 'empName',
	                  align : 'center'
	               }, {
		               header : '부서',
		               name : 'empDept',
		               align : 'center'
		               }]
	            }); 
			   
			    function emp(){
				   
				   url="eList"
				       fetch(url) 
				       .then(res=>res.json())
				       .then(obj=>{
				           empGrid.resetData(obj);
				       })
			   } 
			   
			   // 사원 그리드 클릭하면 input 태그에 뿌려주기
			    empGrid.on('click',ev => {
				  let rowData=empGrid.getRow(ev.rowKey);
				  
				  let a = rowData['empName'];

				  
				  $('#empNo').val(a);

				  
				  $('#empModal').modal("hide");
			   }); 
			   
            
           
        	   
          
            
        	  
           

         </script>
      </main>
   </article>
</body>
</html>
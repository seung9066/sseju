<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
   xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5"
   xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
   layout:decorate="~{/layout/layout}">
<head>
<meta charset="UTF-8">
<title>workOrderList</title>
<!-- 제이쿼리 -->
<script
	src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
<!-- 토스트UI -->
<link rel="stylesheet"
	href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
<script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>

<style type="text/css">
.row {
	margin: 15px;
}

h4 {
	display: inline-block;
}
td{
	padding : 0;
}
input {
	padding : 0;
}
</style>
</head>
<body>
	<article layout:fragment="content">
		<main id="main" class="main">
			<h4>
				<strong>작업 지시 관리</strong>
			</h4>
			<br>
			<div style="float:right;">
				<!-- <button type="submit" class="button" onclick="addWorkOrder()">추가</button> -->
				<button class="button" onclick="updateWorkOrder()">수정</button>
				<button class="button" onclick="selectDelete()">삭제</button>
			</div>
			
			<!-- DB에서 불러온 데이터 grid로 띄워줌
			grid에 띄워진 list를 클릭하면 상세정보가 나오게 할 수 있는지 알아봐야함
			 -->
			<div id="workorderGrid"></div>
			
			<!-- 작업 지시 등록 칸 -->
			<br>
			<h6 style="display: inline-block;">작업 지시 등록</h6>
			<div style="float:right;">
			</div>
			
			<form action="insertWorkOrder" method="post">
				<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
				<input type="hidden" name="auth" value="ROLE_ADMIN">
				<button type="submit" class="button" style="float: right">등록</button>	
				<div>
					<table class="table">
						<tr>
							<th>품목명</th>
								<td>
									<select id="woPrt" name="woPrt">
										<option>---선택---</option>
										<option value="PRD_001">오리지널</option>
										<option value="PRD_002">청포도</option>
										<option value="PRD_003">자몽</option>
										<option value="PRD_004">유자</option>
										<option value="PRD_005">석류</option>
										<option value="PRD_006">블루베리</option>
									</select>
								</td>
							<th>담당자</th>
							<td><input type="text" name="preManager" id="preManager"></td>
							<th>지시수량</th>
							<td><input type="number" name="preQty" id="preQty" min="1"></td>
							<th>납기 일자</th>
							<!-- 납기 일자로 할 경우에는 날짜 선택 가능해야함 -->
							<td><input type="date" name="preDate" id="preDate"></td>							
						</tr>
					</table>
				</div>
			</form>

			<script type="text/javascript">
			/* 값 주고받기 위한 시큐리티 설정 */
			showAll();
			
			var workOrderGrid = new tui.Grid({
				 el: document.getElementById('workorderGrid'),
					pagination:true,
					pageOption: {
						useClient:true,
						perPage:5
					},
			        scrollX : false,
			        scrollY : true,
				    rowHeaders: ['checkbox'],
				    columns: [
						{
							header: '작업 지시 번호',
						    name: 'preNo'
						},
						{
							header: '납기일자',
					    	name: 'dDay',
					    	filter : 'select'
						},
						{
							header: '품목',
						    name: 'prtName',
						    filter : 'select'
						},
						{
						 	header: '생산수량',
						    name: 'preQty'
						},
						{
						 	header: '지시수량',
						    name: 'inQty'
						},
						{
						    header : '진행상태',
						    name:'prePrg',
						    filter : 'select'
						}]
				      });
			
				var token = $("meta[name='_csrf']").attr("content");
				var header = $("meta[name='_csrf_header']").attr("content");
				
				var deleteWorkOrder = [];
				
			   	workOrderGrid.on('check', ev => {
				      console.log(workOrderGetid.getValue(ev.rowKey, 'preNo'));
				      deleteWorkOrder.push((workOrderGrid.getValue(ev.rowKey, 'preNo')));
				      
				      console.log($('input[name=_checked]').val());
				      
				      $('#preNo').val(workOrderGrid.getValue(ev.RowKey, 'preNo'));
				      $('#preNo').attr('readonly', true);
				      $('#dDay').val(workOrderGrid.getValue(ev.rowKey, 'dDay'));
				      $('#prtName').val(workOrderGrid.getValue(ev.rowKey, 'prtName'));
				      $('#preQty').val(workOrderGrid.getValue(ev.rowKey, 'preQty'));
				      $('#insQty').val(workOrderGrid.getValue(ev.rowKey, 'insQty'));
				      $('#prePrg').val(workOrderGrid.getValue(ev.rowKey, 'prePrg'));
				    });

			   	workOrderGrid.on('uncheck', ev => {
				      console.log(workOrderGrid.getValue(ev.rowKey, 'preNo'));
				      for(let i=0; i<deleteWorkOrder.length; i++){
				    	  if(deleteWorkOrder[i] == workOrderGrid.getValue(ev.rowKey, 'preNo')){
				    		  deleteWorkOrder.splice(i, 1);
				    	  }
				      }
				      $('#preNo').val('');
				      $('#preNo').attr('readonly', true);
				      $('#dDay').val('');
				      $('#prtName').val('');
				      $('#preQty').val('');
				      $('#insQty').val('');
				      $('#prePrg').val('');
				    });
			    /* grid.on('focusChange', ev => {
				      console.log('change focused cell!', ev);
				    }); */
			   	
			   	function selectDelete(){
				    	
					let workOrder = [];
					for(wo of workOrderGrid.getCheckedRows()){
						console.log(wo);
						workOrder.push(wo.preNo);
						console.log(workOrder);
					}
			   	$.ajax({
			   		url : 'selectDeleteWO',
			   		type : 'POST',
			   		data : JSON.Stringify({deleteWorkOrder : deleteWorkOrder}),
			   		dataType : "json",
			   		async:false,
			   		beforeSend : function(xhr){
			   			xhr.setRequestHeader(header, token);
			   		},
			   		success : function(data){
			   			if(data > 0){
			   				alert("삭제완료")
			   				showAll();
			   			}else{
			   				alert("삭제 실패")
			   			}
			   		},
			   		error:function(request,status,error){
			   			alert("code : " + request.status+
			   					"\n"+"message : " + request.responseText + 
			   						"\n"+"error : " + error);
			   			console.log(code);
			   			console.log(reject);
					   		}
					   	})
					}

					function showAll() {
						       fetch("getWorkOrderList") 
						       .then(res=>res.json())
						       .then(obj=>{
						           console.log(obj);
						           workOrderGrid.resetData(obj);
						       })
					}

		</script>
		</main>
	</article>
	
</body>

</html>